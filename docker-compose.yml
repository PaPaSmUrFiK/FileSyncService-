version: "3.9"

services:
  # =========================
  # Infrastructure (BASE)
  # =========================

  postgres:
    image: postgres:15-alpine
    container_name: filesync-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: postgres
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sh:/docker-entrypoint-initdb.d/01-init-db.sh
    networks:
      - filesync-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  db-init:
    image: postgres:15-alpine
    container_name: filesync-db-init
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - filesync-network
    environment:
      PGPASSWORD: secret
    command: >
      sh -c "
        psql -h postgres -U postgres -tc \"SELECT 1 FROM pg_catalog.pg_user WHERE usename = 'filesync'\" | grep -q 1 ||
        psql -h postgres -U postgres -c \"CREATE USER filesync WITH PASSWORD 'secret';\";

        for db in auth_db user_db file_db storage_db sync_db notification_db; do
          if ! psql -h postgres -U postgres -tc \"SELECT 1 FROM pg_database WHERE datname = '$$db'\" | grep -q 1; then
            psql -h postgres -U postgres -c \"CREATE DATABASE $$db OWNER filesync;\"
            psql -h postgres -U postgres -c \"GRANT ALL PRIVILEGES ON DATABASE $$db TO filesync;\"
          fi
        done
      "

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: filesync-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      KAFKA_OPTS: "-Dzookeeper.4lw.commands.whitelist=ruok"
    networks:
      - filesync-network
    healthcheck:
      test: [ "CMD", "cub", "zk-ready", "localhost:2181", "10" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 15s

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: filesync-kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - filesync-network
    healthcheck:
      test: [ "CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092" ]
      interval: 10s
      timeout: 10s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: filesync-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_SERVER_URL: http://localhost:9000 # Для корректных presigned URLs
    volumes:
      - minio_data:/data
    networks:
      - filesync-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3

  # Настройка CORS и бакетов для MinIO
  minio-setup:
    image: minio/mc
    container_name: filesync-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - filesync-network
    entrypoint: >
      /bin/sh -c " mc alias set myminio http://minio:9000 minioadmin minioadmin; mc mb --ignore-existing myminio/file-sync-storage; mc anonymous set public myminio/file-sync-storage;

      # Создаем файл конфигурации CORS echo '<?xml version=\"1.0\" encoding=\"UTF-8\"?><CORSConfiguration xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\"><CORSRule><AllowedOrigin>*</AllowedOrigin><AllowedMethod>PUT</AllowedMethod><AllowedMethod>POST</AllowedMethod><AllowedMethod>GET</AllowedMethod><AllowedMethod>DELETE</AllowedMethod><AllowedHeader>*</AllowedHeader><ExposeHeader>ETag</ExposeHeader></CORSRule></CORSConfiguration>' > /tmp/cors.xml;

      # Применяем CORS к бакету mc cors set myminio/file-sync-storage /tmp/cors.xml;

      echo 'MinIO setup completed successfully'; exit 0; "

  consul:
    image: hashicorp/consul:1.15
    container_name: filesync-consul
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    command: "agent -server -bootstrap-expect=1 -ui -client=0.0.0.0"
    networks:
      - filesync-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8500/v1/status/leader" ]
      interval: 10s
      timeout: 5s
      retries: 5

  mailpit:
    image: axllent/mailpit:latest
    container_name: filesync-mailpit
    ports:
      - "8025:8025"
      - "1025:1025"
    networks:
      - filesync-network
    restart: unless-stopped

  # =========================
  # MIGRATORS (BEFORE SERVICES)
  # =========================

  storage-migrator:
    build:
      context: .
      dockerfile: StorageService/Dockerfile
    container_name: filesync-storage-migrator
    command: ./migrator --db-url="postgres://filesync:secret@postgres:5432/storage_db?sslmode=disable" --migrations-path=./migrations
    depends_on:
      db-init:
        condition: service_completed_successfully
    networks:
      - filesync-network

  sync-migrator:
    build:
      context: .
      dockerfile: SyncService/Dockerfile
    container_name: filesync-sync-migrator
    command: ./migrator --db-url="postgres://filesync:secret@postgres:5432/sync_db?sslmode=disable" --migrations-path=./migrations
    depends_on:
      db-init:
        condition: service_completed_successfully
    networks:
      - filesync-network

  # =========================
  # CORE BACKEND SERVICES
  # =========================

  auth-service:
    build:
      context: ./AuthService
      dockerfile: Dockerfile
    container_name: filesync-auth-service
    ports:
      - "8081:8081"
      - "9091:9091"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      CONSUL_HOST: consul
    depends_on:
      db-init:
        condition: service_completed_successfully
      consul:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - filesync-network
    restart: unless-stopped

  user-service:
    build:
      context: ./UserService
      dockerfile: Dockerfile
    container_name: filesync-user-service
    ports:
      - "8082:8082"
      - "9090:9090"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      CONSUL_HOST: consul
      AUTH_SERVICE_HOST: auth-service
      AUTH_SERVICE_PORT: 9091
    depends_on:
      auth-service:
        condition: service_started
    networks:
      - filesync-network
    restart: unless-stopped

  storage-service:
    build:
      context: .
      dockerfile: StorageService/Dockerfile
    container_name: filesync-storage-service
    ports:
      - "9094:9094"
    environment:
      - DB_URL=postgres://filesync:secret@postgres:5432/storage_db?sslmode=disable
      - MINIO_ENDPOINT=minio:9000
      - MINIO_EXTERNAL_ENDPOINT=localhost:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET=file-sync-storage
      - MINIO_USE_SSL=false
      - KAFKA_BROKERS=kafka:29092
    depends_on:
      storage-migrator:
        condition: service_completed_successfully
      minio:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - filesync-network
    restart: unless-stopped

  file-service:
    build:
      context: ./FIleService
      dockerfile: Dockerfile
    container_name: filesync-file-service
    ports:
      - "8083:8083"
      - "9093:9093"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      CONSUL_HOST: consul
      AUTH_SERVICE_HOST: auth-service
      AUTH_SERVICE_PORT: 9091
      USER_SERVICE_HOST: user-service
      USER_SERVICE_PORT: 9090
      STORAGE_SERVICE_HOST: storage-service
      STORAGE_SERVICE_PORT: 9094
    depends_on:
      db-init:
        condition: service_completed_successfully
      user-service:
        condition: service_started
      storage-service:
        condition: service_started
    networks:
      - filesync-network
    restart: unless-stopped

  sync-service:
    build:
      context: .
      dockerfile: SyncService/Dockerfile
    container_name: filesync-sync-service
    ports:
      - "8084:8084"
      - "9095:9095"
    environment:
      - DB_URL=postgres://filesync:secret@postgres:5432/sync_db?sslmode=disable
      - KAFKA_BROKERS=kafka:29092
      - GRPC_PORT=9095
      - HTTP_PORT=8084
    depends_on:
      sync-migrator:
        condition: service_completed_successfully
      kafka:
        condition: service_healthy
    networks:
      - filesync-network
    restart: unless-stopped

  notification-service:
    build:
      context: ./NotificationService
      dockerfile: Dockerfile
    container_name: filesync-notification-service
    ports:
      - "8085:8085"
      - "9096:9096"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      CONSUL_HOST: consul
      MAIL_HOST: mailpit
      MAIL_PORT: 1025
    depends_on:
      db-init:
        condition: service_completed_successfully
      kafka:
        condition: service_healthy
      mailpit:
        condition: service_started
    networks:
      - filesync-network
    restart: unless-stopped

  # =========================
  # API GATEWAY (LAST)
  # =========================

  api-gateway:
    build:
      context: ./GatewayService
      dockerfile: Dockerfile
    container_name: filesync-api-gateway
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      CONSUL_HOST: consul
      SYNC_SERVICE_HTTP_URL: http://sync-service:8084
      AUTH_SERVICE_HOST: auth-service
      AUTH_SERVICE_PORT: 9091
      USER_SERVICE_HOST: user-service
      USER_SERVICE_PORT: 9090
      FILE_SERVICE_HOST: file-service
      FILE_SERVICE_PORT: 9093
      STORAGE_SERVICE_HOST: storage-service
      STORAGE_SERVICE_PORT: 9094
      SYNC_SERVICE_HOST: sync-service
      SYNC_SERVICE_PORT: 9095
      NOTIFICATION_SERVICE_HOST: notification-service
      NOTIFICATION_SERVICE_PORT: 9096
    depends_on:
      auth-service:
        condition: service_started
      user-service:
        condition: service_started
      file-service:
        condition: service_started
      storage-service:
        condition: service_started
      sync-service:
        condition: service_started
      notification-service:
        condition: service_started
    networks:
      - filesync-network
    restart: unless-stopped

networks:
  filesync-network:
    driver: bridge

volumes:
  postgres_data:
  minio_data:
