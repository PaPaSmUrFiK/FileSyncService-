syntax = "proto3"; // Protobuf v3

package filesync.sync.v1; // Versioned package

option go_package = "github.com/PaPaSmUrFiK/FileSyncService-/filesync-internal-contracts/gen/go/filesync/sync/v1;syncv1";

// SyncService реализует движок синхронизации между устройствами.
// Сервис НЕ управляет файлами напрямую, а работает через события и контракты.
service SyncService {

  // Регистрация нового устройства
  rpc RegisterDevice (RegisterDeviceRequest) returns (DeviceResponse);

  // Получение текущего статуса синхронизации
  rpc GetSyncStatus (SyncStatusRequest) returns (SyncStatusResponse);

  // Отправка локальных изменений клиента
  rpc PushChanges (PushChangesRequest) returns (PushChangesResponse);

  // Получение изменений с сервера
  rpc PullChanges (PullChangesRequest) returns (PullChangesResponse);

  // Разрешение конфликта версий
  rpc ResolveConflict (ConflictResolutionRequest) returns (EmptyResponse);

  // Отключение устройства
  rpc UnregisterDevice (UnregisterDeviceRequest) returns (EmptyResponse);

  // Получение списка устройств пользователя
  rpc GetDevices (GetDevicesRequest) returns (DevicesListResponse);
}

// ===== Device =====

message RegisterDeviceRequest {
  string user_id = 1;       // ID пользователя
  string device_name = 2;   // Имя устройства
  string device_type = 3;   // desktop | mobile | tablet
  string os = 4;            // Операционная система
  string os_version = 5;    // Версия ОС
}

message DeviceResponse {
  string device_id = 1;     // ID устройства
  string sync_token = 2;    // Токен для синхронизации
  string registered_at = 3; // ISO timestamp
}

// ===== Sync status =====

message SyncStatusRequest {
  string device_id = 1;
  string user_id = 2;
}

message SyncStatusResponse {
  string device_id = 1;
  string status = 2;        // synced | syncing | pending | error
  string last_sync = 3;
  int32 pending_changes = 4;
  int32 synced_files = 5;
  string sync_cursor = 6;
}

// ===== Changes =====

message FileChange {
  string file_id = 1;
  string file_path = 2;
  string change_type = 3;   // created | modified | deleted | renamed
  string file_hash = 4;
  int64 file_size = 5;
  int32 local_version = 6;
  string client_timestamp = 7;
  optional string old_path = 8; // Для rename
}

message PushChangesRequest {
  string device_id = 1;
  string user_id = 2;
  repeated FileChange changes = 3;
}

message ChangeResult {
  string file_id = 1;
  string status = 2;        // success | conflict | error
  optional string upload_url = 3;
  optional int32 server_version = 4;
  optional string conflict_id = 5;
  optional string error_message = 6;
}

message PushChangesResponse {
  repeated ChangeResult results = 1;
  string sync_cursor = 2;
}

// ===== Pull =====

message PullChangesRequest {
  string device_id = 1;
  string user_id = 2;
  optional string last_sync_cursor = 3;
}

message FileChangeInfo {
  string file_id = 1;
  string change_type = 2;
  string file_path = 3;
  string file_name = 4;
  int64 file_size = 5;
  string file_hash = 6;
  int32 version = 7;
  string mime_type = 8;
  bool is_folder = 9;
  optional string download_url = 10;
  string timestamp = 11;
}

message PullChangesResponse {
  repeated FileChangeInfo changes = 1;
  string sync_cursor = 2;
  bool has_more = 3;
}

// ===== Conflicts =====

message ConflictResolutionRequest {
  string conflict_id = 1;
  string user_id = 2;
  string resolution_type = 3; // keep_both | keep_server | keep_local
  optional string chosen_file_id = 4;
}

// ===== Devices =====

message UnregisterDeviceRequest {
  string device_id = 1;
  string user_id = 2;
}

message GetDevicesRequest {
  string user_id = 1;
}

message DeviceInfo {
  string device_id = 1;
  string device_name = 2;
  string device_type = 3;
  string os = 4;
  string last_sync = 5;
  bool is_online = 6;
}

message DevicesListResponse {
  repeated DeviceInfo devices = 1;
}

message EmptyResponse {}

//protoc -I proto proto/filesync/sync/v1/sync.proto --go_out=./gen/go --go_opt=paths=source_relative --go-grpc_out=./gen/go/ --go-grpc_opt=paths=source_relative